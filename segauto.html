<input id="commandInput" type="text" autocomplete="off" />
<ul id="suggestions"></ul>

<script>
    const commandTree = {
        test: {
            rename: {
                '<name>': (name) => io.to(socket.id).emit("server_broadcast_all", `hi there, ${name}`)
            },
            combat_init: {
                alone: () => console.log('alone')
                ,
                party: () => console.log('alone')
            }
        }
    };

    const input = document.getElementById("commandInput");
    const suggestionsBox = document.getElementById("suggestions");

    let suggestionsVisible = false;
    let currentSuggestions = [];

    function getSuggestions() {
        const inputValue = input.value;
        const segments = inputValue.trim().split(/\s+/).filter(Boolean);

        let node = commandTree;
        for (let i = 0; i < segments.length - 1; i++) {
            if (node && node[segments[i]]) {
                node = node[segments[i]];
            } else {
                node = null;
                break;
            }
        }

        let currentSegment = segments[segments.length - 1] || "";
        const endsWithSpace = inputValue.endsWith(" ");

        if (endsWithSpace || segments.length === 0) {
            currentSegment = "";
            node = segments.length === 0 ? commandTree : node?.[segments[segments.length - 1]] ?? null;
        }

        if (node && typeof node === "object") {
            currentSuggestions = Object.keys(node).filter(k => k.startsWith(currentSegment));       
        } else {
            currentSuggestions = [];
        }

        if (suggestionsVisible) {
            renderSuggestions(currentSuggestions, segments, endsWithSpace);
        }
    }

    function renderSuggestions(suggestions, segments, endsWithSpace) {
        suggestionsBox.innerHTML = suggestions.map(s => `<li onclick="selectSuggestion('${segments.slice(0, endsWithSpace ? segments.length : segments.length - 1).concat(s).join(' ')}')">${s}</li>`).join('');
    }


    // this 
    function selectSuggestion(fullCommand) {
        input.value = fullCommand + ' ';
        suggestionsVisible = false;
        suggestionsBox.innerHTML = '';
        getSuggestions(); // Update suggestions based on the new value
    }

    input.addEventListener("input", getSuggestions);

    document.addEventListener("keydown", (e) => {
        if (e.key === "\\") {
            e.preventDefault();
            suggestionsVisible = !suggestionsVisible;
            if (suggestionsVisible) {
                getSuggestions();
            } else {
                suggestionsBox.innerHTML = '';
            }
        }
    });
</script>